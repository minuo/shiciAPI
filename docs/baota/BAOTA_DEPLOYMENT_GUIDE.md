# 诗词API项目 - 宝塔面板部署指南

本文档详细介绍如何使用宝塔面板部署诗词API项目，适合没有专业运维经验的开发者快速部署应用。

## 1. 准备宝塔面板环境

### 1.1 安装宝塔面板

如果您还没有安装宝塔面板，请先在服务器上安装：

```bash
# CentOS系统
curl -sSO http://download.bt.cn/install/install_6.0.sh && bash install_6.0.sh

# Ubuntu/Debian系统
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && bash install.sh
```

安装完成后，记录下登录地址、用户名和密码。

### 1.2 安装必要软件

登录宝塔面板后，在软件商店中安装以下软件：

1. **Node.js** - 选择 v14 或更高版本
2. **MongoDB** - 数据库
3. **Nginx** - Web服务器（用于反向代理，可选）
4. **PM2管理器** - Node.js应用管理工具

安装步骤：
- 点击左侧菜单「软件商店」
- 搜索需要的软件
- 点击「安装」按钮
- 选择版本（推荐使用稳定版）
- 点击「提交」

### 1.3 开放端口

在宝塔面板中开放以下端口：

1. **27017** - MongoDB默认端口
2. **3000** - 应用默认运行端口（或您计划使用的其他端口）

操作步骤：
- 点击左侧菜单「安全」
- 点击「添加规则」
- 输入端口号和备注
- 点击「放行」

## 2. 在宝塔面板中创建网站站点

### 2.1 创建站点

1. 点击左侧菜单「网站」
2. 点击「添加站点」
3. 填写以下信息：
   - **域名**：输入您的域名或服务器IP地址
   - **根目录**：选择一个目录，如 `/www/wwwroot/shiciapi`
   - **创建数据库**：暂不创建（稍后会单独配置MongoDB）
   - **PHP版本**：纯静态（因为这是Node.js项目）
4. 点击「提交」

### 2.2 设置站点配置

1. 进入刚创建的站点
2. 点击「设置」
3. 在「网站目录」选项卡中，确保文件权限正确

## 3. 配置MongoDB数据库

### 3.1 创建数据库和用户

1. 点击左侧菜单「数据库」
2. 选择「MongoDB」选项卡
3. 点击「添加数据库」
4. 填写以下信息：
   - **数据库名**：`shici`
   - **用户名**：`shici_db`（自定义）
   - **密码**：设置一个安全的密码
5. 点击「提交」

### 3.2 配置MongoDB连接

记录下以下连接信息，稍后会用到：
- 数据库地址：`127.0.0.1`（或服务器IP）
- 数据库端口：`27017`
- 数据库名：`shici`
- 用户名：`shici_db`（您设置的用户名）
- 密码：您设置的密码

完整连接字符串格式：
```
mongodb://用户名:密码@地址:端口/数据库名
```

## 4. 部署项目代码到服务器

### 4.1 通过Git部署

1. 进入站点的文件管理界面
2. 删除默认生成的文件（如index.html）
3. 点击「终端」
4. 执行以下命令克隆代码：

```bash
cd /www/wwwroot/shiciapi  # 进入站点根目录
git clone https://github.com/您的用户名/shiciAPI.git .  # 注意最后的点，不要创建新目录
```

如果遇到权限问题，执行：
```bash
chmod -R 755 /www/wwwroot/shiciapi
```

### 4.2 或者通过文件上传

如果无法使用Git，也可以：
1. 在本地将项目打包成zip文件
2. 进入站点的文件管理界面
3. 点击「上传」
4. 上传zip文件后，点击「解压」

## 5. 配置环境变量和依赖安装

### 5.1 创建环境变量文件

1. 在项目根目录创建`.env`文件
2. 编辑内容如下：

```
# MongoDB连接字符串
MONGODB_URI=mongodb://shici_user:您设置的密码@127.0.0.1:27017/shici

# JWT密钥（请修改为您自己的密钥）
JWT_SECRET=your_jwt_secret_key_here_change_this

# 服务器端口
PORT=3000
```

### 5.2 安装依赖

1. 进入站点的「终端」
2. 执行以下命令：

```bash
cd /www/wwwroot/shiciapi
npm install --production  # 仅安装生产依赖，加快安装速度
```

## 6. 使用PM2管理Node.js应用

### 6.1 创建PM2应用

1. 点击左侧菜单「软件商店」
2. 找到已安装的「PM2管理器」并点击「设置」
3. 点击「添加项目」
4. 填写以下信息：
   - **项目名称**：`shiciAPI`
   - **运行目录**：`/www/wwwroot/shiciapi`
   - **启动文件**：`server.js`
   - **运行用户**：`www`
   - **端口**：`3000`（与.env文件中的PORT一致）
5. 点击「提交」

### 6.2 配置PM2自动启动

1. 在PM2管理器中，勾选刚创建的应用
2. 点击「更多」→「自动启动」

### 6.3 重启应用

如果需要重启应用：
1. 在PM2管理器中找到您的应用
2. 点击「重启」按钮

## 7. 配置Nginx反向代理（可选）

如果您希望通过域名或80端口访问应用，可以配置Nginx反向代理：

### 7.1 添加反向代理

1. 进入站点设置
2. 点击「反向代理」选项卡
3. 点击「添加反向代理」
4. 填写以下信息：
   - **代理名称**：`shiciAPI`
   - **目标URL**：`http://127.0.0.1:3000`（应用运行的地址和端口）
   - **发送域名**：保持默认
5. 点击「提交」

### 7.2 配置WebSocket支持（如果需要）

如果应用需要WebSocket支持，在反向代理配置中添加：

```nginx
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
```

## 8. 验证API服务是否正常运行

### 8.1 检查PM2状态

1. 在PM2管理器中查看应用状态，应该显示为「运行中」
2. 点击「日志」可以查看详细日志

### 8.2 测试API访问

使用浏览器或工具（如Postman）访问：

```
http://您的域名或IP/  # 根路径，应该返回健康检查信息
```

或使用curl命令：

```bash
curl http://您的域名或IP/
```

如果返回以下内容，说明服务运行正常：

```json
{
  "code": 200,
  "msg": "诗词 API 服务运行正常",
  "data": null
}
```

### 8.3 初始化数据（可选）

如果需要初始化示例数据，可以执行：

```bash
cd /www/wwwroot/shiciapi
node seed.js
```

## 9. 常见问题排查

### 9.1 应用无法启动

1. 检查PM2日志，查看具体错误信息
2. 验证环境变量配置是否正确
3. 确认数据库是否正常运行且连接信息正确
4. 检查端口是否被占用：
   ```bash
   netstat -tlnp | grep 3000
   ```

### 9.2 数据库连接失败

1. 检查MongoDB是否正常运行
2. 验证数据库用户名和密码是否正确
3. 确保数据库防火墙规则已设置正确

### 9.3 权限问题

如果遇到文件权限问题，执行：

```bash
chmod -R 755 /www/wwwroot/shiciapi
chown -R www:www /www/wwwroot/shiciapi
```

### 9.4 端口访问问题

1. 确认宝塔面板的安全设置中已开放相关端口
2. 检查服务器防火墙是否允许端口访问
3. 如果使用云服务器，确认安全组规则是否配置正确

## 10. 自动化更新（可选）

为了方便后续更新，可以创建一个简单的更新脚本：

1. 在项目根目录创建`update.sh`文件：

```bash
#!/bin/bash

# 进入项目目录
cd /www/wwwroot/shiciapi

# 拉取最新代码
git pull

# 安装新依赖
npm install --production

# 重启应用
pm restart

echo "更新完成"
```

2. 设置执行权限：
```bash
chmod +x update.sh
```

3. 后续更新时，只需在终端执行：
```bash
./update.sh
```

---

通过以上步骤，您应该能够成功在宝塔面板上部署诗词API项目。如果您遇到任何问题，请参考项目的其他文档或寻求技术支持。